openapi: 3.1.0
info:
  title: M3 Memory Server â€” Tiny API Map
  version: 0.1.9
  description: |
    Minimal, handâ€‘rolled OpenAPI for the endpoints currently wired in `server/`.
    Scope: cycles, emotions, and the Value Bridge (accounts + entries). Intended
    for docs and lightweight client generation. This file is small by design â€”
    extend as features stabilize.

    Whisper: "label the pieces and the path reveals itself." ğŸŒ¬ï¸
  contact:
    name: GratiaOS
    url: https://github.com/GratiaOS
  license:
    name: AGPL-3.0-only
    url: https://www.gnu.org/licenses/agpl-3.0.html

servers:
  - url: http://127.0.0.1:3033
    description: Local dev (default bind unless `M3_BIND` overrides)
  - url: /
    description: Relative (reverseâ€‘proxy / container)

security: []

tags:
  - name: cycles
    description: Astral cycle snapshots and upcoming milestones (fast approximations).
  - name: emotions
    description: Emotion capture + bridges (A11yâ€‘first, privacyâ€‘aware).
  - name: value
    description: Value Bridge (accounts + entries in minor units).
  - name: towns
    description: Local interâ€‘species bulletin; quick news notes per town.

paths:
  /towns/news:
    post:
      tags: [towns]
      summary: Post a news note to a town bulletin
      operationId: postTownNews
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewsIn'
            examples:
              sample:
                value:
                  town: CatTown
                  headline: 'Pillow rotation tonight'
                  who: 'cat:felix'
                  note: 'new pillows in bedroom; queue starts on window shelf'
              sunbeamShift:
                value:
                  town: CatTown
                  headline: 'Sunbeam shifts to couch at 14:00'
                  who: 'cat:all'
                  note: 'afternoon sun leaves window; couch and rug are warm'
      responses:
        '200':
          description: Created news echo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NewsOut'
        '422':
          $ref: '#/components/responses/ValidationError'

  /towns/bulletin:
    get:
      tags: [towns]
      summary: List recent town news (newest first)
      operationId: getTownBulletin
      parameters:
        - $ref: '#/components/parameters/TownParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NewsOut'
              examples:
                recentCatTown:
                  value:
                    - id: 101
                      created_at: '2025-10-20T21:00:00Z'
                      town: CatTown
                      headline: 'Pillow rotation tonight'
                      note: 'new pillows in bedroom; queue starts on window shelf'
                      who: 'cat:felix'
                    - id: 102
                      created_at: '2025-10-20T12:58:00Z'
                      town: CatTown
                      headline: 'Sunbeam shifts to couch at 14:00'
                      note: 'afternoon sun leaves window; couch and rug are warm'
                      who: 'cat:all'
                morningAndEvening:
                  value:
                    - id: 103
                      created_at: '2025-10-20T06:55:00Z'
                      town: CatTown
                      headline: 'Door patrol paused for breakfast'
                      note: 'porch watch resumes after 08:15'
                      who: 'cat:felix'
                    - id: 104
                      created_at: '2025-10-20T18:40:00Z'
                      town: CatTown
                      headline: 'Cushion claimed by Manolita'
                      note: 'corner pillow marked; alternate spots encouraged'
                      who: 'cat:all'
        '400':
          $ref: '#/components/responses/BadRequest'
  /cycles/current:
    get:
      tags: [cycles]
      summary: Current cycle state
      operationId: getCurrentCycles
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CycleState'
              examples:
                ok:
                  value:
                    lunar: full_moon
                    solar: libra
                    pleiadian: tone_7_reflection
                    ts: '2025-10-20T10:00:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'

  /cycles/upcoming:
    get:
      tags: [cycles]
      summary: Next cycle milestones
      operationId: getUpcomingCycles
      parameters:
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CycleMilestone'
              examples:
                ok:
                  value:
                    - kind: lunar
                      phase: first_quarter
                      at: '2025-10-23T03:21:00Z'
                    - kind: solar
                      phase: scorpio
                      at: '2025-10-23T10:05:00Z'
                    - kind: pleiadian
                      phase: tone_8_integrity
                      at: '2025-10-21T00:00:00Z'
        '400':
          $ref: '#/components/responses/BadRequest'

  /emotions/add:
    post:
      tags: [emotions]
      summary: Add an emotion sample
      operationId: addEmotion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EmotionIn'
            examples:
              sample:
                value:
                  who: Raz
                  kind: panic
                  intensity: 0.72
                  note_id: null
                  details: 'tax ping + breath; contained'
                  sealed: false
                  archetype: null
                  privacy: private
      responses:
        '200':
          description: Inserted emotion echo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmotionOut'
              examples:
                ok:
                  value:
                    id: 123
                    ts: '2025-10-20T09:41:00Z'
                    who: Raz
                    kind: panic
                    intensity: 0.72
                    note_id: null
                    details: 'tax ping + breath; contained'
                    sealed: false
                    archetype: null
                    privacy: private
                    band: heavy
        '422':
          $ref: '#/components/responses/ValidationError'

  /emotions/recent:
    get:
      tags: [emotions]
      summary: List the most recent emotions (latest first, limit 20)
      operationId: listRecentEmotions
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EmotionOut'
        '400':
          $ref: '#/components/responses/BadRequest'

  /emotions/bridge:
    post:
      tags: [emotions]
      summary: Suggest a breath/doorway/anchor for a given label + intensity
      operationId: feelBridge
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BridgeIn'
            examples:
              sample:
                value:
                  kind: anxiety
                  intensity: 0.65
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BridgeOut'
              examples:
                ok:
                  value:
                    breath: 'box: in4-hold4-out6 Ã— 4'
                    doorway: 'sip water, feet on floor'
                    anchor: 'Name 3 objects you see.'
        '422':
          $ref: '#/components/responses/ValidationError'

  /emotions/resolve:
    post:
      tags: [emotions]
      summary: Land a resolution as gratitude (intensity = 1.0)
      operationId: resolveEmotion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResolveIn'
            examples:
              sample:
                value:
                  who: Raz
                  note_id: null
                  details: 'named loop; gratitude landed'
                  sealed: false
                  archetype: null
                  privacy: private
      responses:
        '200':
          description: Inserted gratitude echo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmotionOut'
        '422':
          $ref: '#/components/responses/ValidationError'

  /value/account:
    post:
      tags: [value]
      summary: Create (or fetch) a value account by name
      operationId: createValueAccount
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValueAccountCreate'
            examples:
              sample:
                value:
                  name: 'cash:home'
                  kind: wallet
                  currency: EUR
      responses:
        '200':
          description: Existing or newly-created account descriptor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValueAccountOut'
              examples:
                ok:
                  value:
                    id: 7
                    name: 'cash:home'
                    kind: wallet
                    currency: EUR
        '422':
          $ref: '#/components/responses/ValidationError'

  /value/balance:
    get:
      tags: [value]
      summary: Oneâ€‘line balance (minor + computed major units)
      operationId: getAccountBalance
      parameters:
        - $ref: '#/components/parameters/AccountParam'
        - $ref: '#/components/parameters/CurrencyParam'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BalanceOut'
              examples:
                ok:
                  value:
                    account: 'cash:home'
                    currency: EUR
                    balance_minor: 12345
                    balance_major: 123.45
        '400':
          $ref: '#/components/responses/BadRequest'

  /value/entry:
    post:
      tags: [value]
      summary: Insert a value entry (major units in request â†’ minor units in storage)
      operationId: addValueEntry
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValueEntryCreate'
            examples:
              income:
                value:
                  account: 'cash:home'
                  direction: in
                  amount: 77.00
                  currency: EUR
                  memo: 'sponsor â€” Grove'
                  tags: 'sponsor,github'
              expense:
                value:
                  account: 'cash:home'
                  direction: out
                  amount: 12.34
                  currency: EUR
                  memo: 'coffee w/ fam'
      responses:
        '200':
          description: Created (row id)
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    format: int64
                required: [id]
        '422':
          $ref: '#/components/responses/ValidationError'

  /value/recent:
    get:
      tags: [value]
      summary: List newest entries (optionally filtered by account)
      operationId: listRecentValueEntries
      parameters:
        - $ref: '#/components/parameters/AccountParam'
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 500, default: 50 }
          description: Max rows to return.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ValueEntryRow'
        '400':
          $ref: '#/components/responses/BadRequest'

components:
  parameters:
    TownParam:
      in: query
      name: town
      schema: { type: string }
      description: Optional town name; omit for all towns.
    AccountParam:
      in: query
      name: account
      schema: { type: string }
      description: Optional account name; omit for all accounts.
    CurrencyParam:
      in: query
      name: currency
      schema: { type: string, minLength: 3, maxLength: 3 }
      description: Optional threeâ€‘letter currency (defaults to base currency).
    LimitParam:
      in: query
      name: limit
      schema: { type: integer, minimum: 1, maximum: 12, default: 3 }
      description: Max number of milestones to return.

  responses:
    ValidationError:
      description: Input failed validation
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'
          examples:
            badIntensity:
              value:
                code: UNPROCESSABLE_ENTITY
                message: 'intensity must be within 0..1'
                details:
                  field: intensity
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ApiError'

  schemas:
    # â”€â”€ cycles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    CycleState:
      type: object
      properties:
        lunar: { type: string, description: 'e.g., new_moon, full_moon' }
        solar: { type: string, description: 'tropical sign, e.g., libra' }
        pleiadian: { type: string, description: 'tone_n_label, e.g., tone_7_reflection' }
        ts: { type: string, format: date-time }
      required: [lunar, solar, pleiadian, ts]

    CycleMilestone:
      type: object
      properties:
        kind: { type: string, description: 'lunar | solar | pleiadian' }
        phase: { type: string }
        at: { type: string, format: date-time }
      required: [kind, phase, at]

    # â”€â”€ emotions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    EmotionIn:
      type: object
      properties:
        who: { type: string }
        kind: { type: string, description: 'e.g., impulsiveness | panic | joy' }
        intensity: { type: number, minimum: 0, maximum: 1 }
        note_id: { type: [integer, 'null'], format: int64 }
        details: { type: [string, 'null'] }
        sealed: { type: boolean, description: 'mirror tag' }
        archetype: { type: [string, 'null'] }
        privacy: { type: string, description: 'private | sealed | anonymized | public' }
      required: [who, kind, intensity, sealed, privacy]

    EmotionOut:
      allOf:
        - $ref: '#/components/schemas/EmotionIn'
        - type: object
          properties:
            id: { type: integer, format: int64 }
            ts: { type: string, format: date-time }
            band: { type: string, description: 'computed band, e.g., slow | flow | heavy' }
          required: [id, ts, band]

    BridgeIn:
      type: object
      properties:
        kind: { type: string, description: 'e.g., anxiety | anger | shame | gratitude' }
        intensity: { type: number, minimum: 0, maximum: 1 }
      required: [kind, intensity]

    BridgeOut:
      type: object
      properties:
        breath: { type: string }
        doorway: { type: string }
        anchor: { type: string }
      required: [breath, doorway, anchor]

    ResolveIn:
      type: object
      properties:
        who: { type: string }
        note_id: { type: [integer, 'null'], format: int64 }
        details: { type: [string, 'null'] }
        sealed: { type: [boolean, 'null'] }
        archetype: { type: [string, 'null'] }
        privacy: { type: [string, 'null'] }
      required: [who]

    # â”€â”€ value bridge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ValueAccountCreate:
      type: object
      properties:
        name: { type: string }
        kind: { type: [string, 'null'], description: "defaults to 'wallet'" }
        currency: { type: [string, 'null'], description: '3â€‘letter code; defaults to base currency' }
      required: [name]

    ValueAccountOut:
      type: object
      properties:
        id: { type: integer, format: int64 }
        name: { type: string }
        kind: { type: string }
        currency: { type: string }
      required: [id, name, kind, currency]

    ValueEntryCreate:
      type: object
      properties:
        account: { type: string, description: 'account name' }
        account_kind: { type: [string, 'null'], description: "defaults to 'wallet'" }
        ts: { type: [string, 'null'], format: date-time, description: 'RFC3339; omit for now()' }
        direction: { type: string, enum: ['in', 'out'] }
        amount: { type: number, description: 'major units (e.g., 12.34)' }
        currency: { type: [string, 'null'], description: '3â€‘letter code; defaults to base currency' }
        memo: { type: [string, 'null'] }
        tags: { type: [string, 'null'], description: 'JSON or commaâ€‘list' }
        counterparty: { type: [string, 'null'] }
        reference: { type: [string, 'null'] }
      required: [account, direction, amount]

    BalanceOut:
      type: object
      properties:
        account: { type: [string, 'null'] }
        currency: { type: string }
        balance_minor: { type: integer, format: int64, description: 'signed minor units (in - out)' }
        balance_major: { type: number, description: 'computed major units (e.g., 123.45)' }
      required: [currency, balance_minor, balance_major]

    ValueEntryRow:
      type: object
      properties:
        id: { type: integer, format: int64 }
        ts: { type: string, format: date-time }
        account: { type: string }
        direction: { type: string, enum: ['in', 'out'] }
        amount_minor: { type: integer, format: int64 }
        amount_major: { type: number, description: 'derived from minor and currency exponent' }
        currency: { type: string }
        memo: { type: [string, 'null'] }
        tags: { type: [string, 'null'] }
        counterparty: { type: [string, 'null'] }
        reference: { type: [string, 'null'] }
      required: [id, ts, account, direction, amount_minor, amount_major, currency]

    # â”€â”€ common â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ApiError:
      type: object
      properties:
        code: { type: string }
        message: { type: string }
        details:
          oneOf:
            - type: string
            - type: object
            - type: array
              items: {}
            - type: 'null'
      required: [code, message]

    NewsIn:
      type: object
      properties:
        town: { type: string, description: 'Town identifier, e.g., CatTown' }
        headline: { type: string, description: 'Primary whisper text (one line)' }
        who: { type: [string, 'null'], description: 'Optional author / source' }
        note: { type: [string, 'null'], description: 'Secondary clarifying note' }
        created_at:
          type: [string, 'null']
          format: date-time
          description: 'Override timestamp (defaults to server now)'
      required: [town, headline]

    NewsOut:
      type: object
      properties:
        id: { type: integer, format: int64 }
        town: { type: string }
        headline: { type: string }
        who: { type: [string, 'null'] }
        note: { type: [string, 'null'] }
        created_at: { type: string, format: date-time }
      required: [id, town, headline, created_at]
